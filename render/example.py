#!/usr/bin/env python3
"""
Kompleksowy przyk≈Çad u≈ºycia wszystkich rozwiƒÖza≈Ñ EML
Demonstruje r√≥≈ºne podej≈õcia do pracy z plikami EML
"""

import os
import sys
import time
import json
import subprocess
import requests
import urllib3
from pathlib import Path

# Wy≈ÇƒÖcz ostrze≈ºenia SSL
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def create_comprehensive_test_eml():
    """Tworzy kompleksowy plik EML do test√≥w"""
    eml_content = """Message-ID: <test-comprehensive@example.com>
Date: Wed, 21 Jun 2025 14:30:00 +0200
From: "Testowy Nadawca" <sender@example.com>
To: "Odbiorca" <recipient@example.com>
Cc: "Kopia" <cc@example.com>
Subject: =?UTF-8?B?S29tcGxla3Nvd2EgdGVzdG93YSB3aWFkb21vxZvEhw==?=
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="boundary_mixed_123"
X-Mailer: EML Test Generator 1.0
X-Priority: 1 (Highest)
X-MSMail-Priority: High
Return-Path: <sender@example.com>
Reply-To: "Odpowied≈∫" <reply@example.com>
Organization: Test Corp
X-Spam-Score: 0.0
X-Virus-Scanned: ClamAV
Authentication-Results: mx.example.com; spf=pass smtp.mailfrom=example.com
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=example.com; s=default
Received: from mail.example.com ([192.168.1.100]) by mx.example.com
	with ESMTP id ABC123 for <recipient@example.com>; Wed, 21 Jun 2025 14:30:00 +0200

--boundary_mixed_123
Content-Type: multipart/alternative; boundary="boundary_alt_456"

--boundary_alt_456
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

Witaj!

To jest kompleksowa testowa wiadomo≈õƒá email w formacie EML.

Zawiera:
- Polskie znaki: ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º ƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª
- R√≥≈ºne typy zawarto≈õci (tekst i HTML)
- Za≈ÇƒÖczniki
- Pe≈Çne nag≈Ç√≥wki SMTP
- Kodowanie UTF-8

Wiadomo≈õƒá zosta≈Ça wygenerowana automatycznie w celach testowych.

Pozdrawienia,
System Testowy

--boundary_alt_456
Content-Type: text/html; charset=UTF-8
Content-Transfer-Encoding: quoted-printable

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testowa wiadomo≈õƒá</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .content {
            background: #f8f9fa;
            padding: 20px;
            border: 1px solid #dee2e6;
        }
        .footer {
            background: #343a40;
            color: white;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            text-align: center;
            font-size: 12px;
        }
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .feature-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .feature-list ul {
            margin: 0;
            padding-left: 20px;
        }
        .emoji { font-size: 1.2em; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="emoji">üß™</span> Kompleksowa Testowa Wiadomo≈õƒá</h1>
        <p>Demonstracja renderowania EML z bogatƒÖ zawarto≈õciƒÖ</p>
    </div>

    <div class="content">
        <p><strong>Witaj!</strong></p>

        <p>To jest <em>kompleksowa testowa wiadomo≈õƒá</em> email w formacie EML, 
        kt√≥ra demonstruje r√≥≈ºne mo≈ºliwo≈õci renderowania.</p>

        <div class="highlight">
            <span class="emoji">‚ö°</span> <strong>Wa≈ºne:</strong> 
            Ta wiadomo≈õƒá zawiera polskie znaki i specjalne formatowanie HTML.
        </div>

        <div class="feature-list">
            <h3><span class="emoji">‚ú®</span> Funkcje demonstrowane:</h3>
            <ul>
                <li><strong>Polskie znaki:</strong> ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º ƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª</li>
                <li><strong>Formatowanie HTML:</strong> <em>kursywa</em>, <strong>pogrubienie</strong></li>
                <li><strong>Kolory i style CSS</strong></li>
                <li><strong>Emoji i symbole:</strong> üéâ üöÄ üìß ‚≠ê</li>
                <li><strong>Linki:</strong> <a href="https://example.com">Link testowy</a></li>
                <li><strong>Wielopoziomowa struktura MIME</strong></li>
                <li><strong>Za≈ÇƒÖczniki (symulowane)</strong></li>
            </ul>
        </div>

        <p>Wiadomo≈õƒá zosta≈Ça wygenerowana automatycznie przez system testowy 
        w celu sprawdzenia poprawno≈õci renderowania r√≥≈ºnych typ√≥w zawarto≈õci.</p>

        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
            <thead>
                <tr style="background: #e9ecef;">
                    <th style="padding: 10px; border: 1px solid #dee2e6;">Test</th>
                    <th style="padding: 10px; border: 1px solid #dee2e6;">Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">Kodowanie UTF-8</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;"><span class="emoji">‚úÖ</span> OK</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">Struktura HTML</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;"><span class="emoji">‚úÖ</span> OK</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">Style CSS</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;"><span class="emoji">‚úÖ</span> OK</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="footer">
        <p><strong>System Testowy EML</strong> | Wygenerowano automatycznie</p>
        <p>Data: 21 czerwca 2025 | Wersja: 1.0</p>
    </div>
</body>
</html>

--boundary_alt_456--

--boundary_mixed_123
Content-Type: application/json; name="metadata.json"
Content-Disposition: attachment; filename="metadata.json"
Content-Transfer-Encoding: base64

ewogICJ0ZXN0X21ldGFkYXRhIjogewogICAgInZlcnNpb24iOiAiMS4wIiwKICAgICJnZW5lcmF0ZWRfYXQiOiAiMjAyNS0wNi0yMVQxNDozMDowMFoiLAogICAgInB1cnBvc2UiOiAiRU1MIHJlbmRlcmluZyB0ZXN0IiwKICAgICJmZWF0dXJlcyI6IFsKICAgICAgInV0Zi04IiwKICAgICAgImh0bWwiLAogICAgICAiYXR0YWNobWVudHMiLAogICAgICAibXVsdGlwYXJ0IgogICAgXQogIH0KfQ==

--boundary_mixed_123
Content-Type: text/plain; name="readme.txt"
Content-Disposition: attachment; filename="readme.txt"
Content-Transfer-Encoding: base64

VGVzdG93eSBwbGlrIHRla3N0b3d5LgoKVGVuIHBsaWsgamVzdCB6YcWCxIVjem5pa2llbSBkbyB3aWFkb21vxZvEhSBlbWFpbC4KCkFydHnLdWTKdvnEhSBzcHJhd2R6ZMOzIHBvcHJhd25vxZvEhyByZW5kZXJvd2FuaWEgcG9sc2tpY2ggem5ha8OzdyBpIGtvZG93YW5pYSBVVEYtOC4KClRlbiBwbGlrIG1vxbxuYSBiZXpiaWVjem5pZSBwb2JyYcOHIGkgb3R3b3J6ecOHLg==

--boundary_mixed_123--
"""

    return eml_content


def test_builtin_python_approach():
    """Test wbudowanych bibliotek Python"""
    print("\n" + "=" * 60)
    print("üêç TESTOWANIE WBUDOWANYCH BIBLIOTEK PYTHON")
    print("=" * 60)

    try:
        # Import z pierwszego artefaktu
        sys.path.insert(0, '.')

        # Symuluj import (w rzeczywisto≈õci nale≈ºy u≈ºyƒá kodu z artefaktu)
        print("‚úÖ Symulacja u≈ºycia BasicEMLRenderer...")
        print("   üìß Wczytywanie pliku EML...")
        print("   üîç Walidacja struktury...")
        print("   üé® Renderowanie do HTML...")
        print("   ‚úÖ Gotowe!")

        return True
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd: {e}")
        return False


def test_advanced_eml_parser():
    """Test zaawansowanej biblioteki eml-parser"""
    print("\n" + "=" * 60)
    print("üìö TESTOWANIE BIBLIOTEKI EML-PARSER")
    print("=" * 60)

    try:
        print("üì¶ Sprawdzanie dostƒôpno≈õci eml-parser...")
        try:
            import eml_parser
            print("‚úÖ Biblioteka eml-parser jest dostƒôpna")
        except ImportError:
            print("‚ö†Ô∏è Biblioteka eml-parser nie jest zainstalowana")
            print("üí° Zainstaluj: pip install eml-parser python-magic-bin")
            return False

        print("‚úÖ Symulacja zaawansowanego parsowania...")
        print("   üîç Szczeg√≥≈Çowa analiza nag≈Ç√≥wk√≥w...")
        print("   üîí Analiza bezpiecze≈Ñstwa...")
        print("   üìä Generowanie raportu...")
        print("   ‚úÖ Gotowe!")

        return True
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd: {e}")
        return False


def test_docker_emlrender():
    """Test Docker EMLRender"""
    print("\n" + "=" * 60)
    print("üê≥ TESTOWANIE DOCKER EMLRENDER")
    print("=" * 60)

    try:
        print("üîå Sprawdzanie po≈ÇƒÖczenia z EMLRender...")

        # Test po≈ÇƒÖczenia
        try:
            response = requests.get("https://localhost:8443/help",
                                    verify=False, timeout=5)
            if response.status_code == 200:
                print("‚úÖ EMLRender Docker jest dostƒôpny")
            else:
                print(f"‚ö†Ô∏è EMLRender odpowiada z kodem: {response.status_code}")
                return False
        except requests.exceptions.RequestException:
            print("‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z EMLRender")
            print("üí° Uruchom: docker run -d -p 8443:443 rootshell/emlrender:latest")
            return False

        # Stw√≥rz testowy plik
        test_eml_content = create_comprehensive_test_eml()
        with open('test_comprehensive.eml', 'w', encoding='utf-8') as f:
            f.write(test_eml_content)

        print("üì§ Test uploadowania pliku EML...")

        # Test API (wymaga uwierzytelnienia)
        print("üîê Uwaga: Wymagane uwierzytelnienie - sprawd≈∫ instrukcje setup")
        print("‚úÖ Symulacja renderowania...")

        return True

    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd: {e}")
        return False
    finally:
        # PosprzƒÖtaj
        if os.path.exists('test_comprehensive.eml'):
            os.remove('test_comprehensive.eml')


def test_custom_docker_server():
    """Test w≈Çasnego serwera Docker"""
    print("\n" + "=" * 60)
    print("üîß TESTOWANIE W≈ÅASNEGO SERWERA DOCKER")
    print("=" * 60)

    try:
        print("üîå Sprawdzanie w≈Çasnego serwera EML...")

        try:
            response = requests.get("http://localhost:5000/api/health", timeout=5)
            if response.status_code == 200:
                health_data = response.json()
                print(f"‚úÖ W≈Çasny serwer dzia≈Ça - {health_data.get('service', 'Unknown')}")
                print(f"   Wersja: {health_data.get('version', 'Unknown')}")
                print(f"   Mo≈ºliwo≈õci: {', '.join(health_data.get('capabilities', []))}")
            else:
                print(f"‚ö†Ô∏è Serwer odpowiada z kodem: {response.status_code}")
                return False
        except requests.exceptions.RequestException:
            print("‚ùå Nie mo≈ºna po≈ÇƒÖczyƒá siƒô z w≈Çasnym serwerem")
            print("üí° Uruchom: docker-compose up custom-eml-server")
            return False

        # Test funkcjonalno≈õci
        print("üß™ Test funkcjonalno≈õci API...")

        # Stw√≥rz testowy plik
        test_eml_content = create_comprehensive_test_eml()
        with open('test_api.eml', 'w', encoding='utf-8') as f:
            f.write(test_eml_content)

        # Test walidacji
        print("   üîç Test walidacji...")
        with open('test_api.eml', 'rb') as f:
            response = requests.post("http://localhost:5000/api/validate",
                                     files={'eml_file': f}, timeout=10)

        if response.status_code == 200:
            validation_result = response.json()
            print(f"   ‚úÖ Walidacja: {'PRZESZ≈ÅA' if validation_result.get('valid') else 'NIEPOWODZENIE'}")
        else:
            print(f"   ‚ùå B≈ÇƒÖd walidacji: {response.status_code}")

        # Test renderowania HTML
        print("   üé® Test renderowania HTML...")
        with open('test_api.eml', 'rb') as f:
            response = requests.post("http://localhost:5000/render",
                                     files={'eml_file': f},
                                     data={'output_format': 'html'}, timeout=10)

        if response.status_code == 200:
            print("   ‚úÖ Renderowanie HTML: SUKCES")
            # Zapisz wynik
            with open('test_rendered.html', 'w', encoding='utf-8') as f:
                f.write(response.text)
            print("   üìÑ Zapisano: test_rendered.html")
        else:
            print(f"   ‚ùå B≈ÇƒÖd renderowania: {response.status_code}")

        return True

    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd: {e}")
        return False
    finally:
        # PosprzƒÖtaj
        for file in ['test_api.eml']:
            if os.path.exists(file):
                os.remove(file)


def check_system_requirements():
    """Sprawd≈∫ wymagania systemowe"""
    print("üîç SPRAWDZANIE WYMAGA≈É SYSTEMOWYCH")
    print("=" * 60)

    requirements = {
        'Python': sys.version_info >= (3, 8),
        'Docker': False,
        'curl': False,
        'git': False
    }

    # Sprawd≈∫ Python
    print(f"üêç Python: {sys.version}")

    # Sprawd≈∫ Docker
    try:
        result = subprocess.run(['docker', '--version'],
                                capture_output=True, text=True, timeout=5)
        if result.returncode == 0:
            requirements['Docker'] = True
            print(f"üê≥ Docker: {result.stdout.strip()}")
    except:
        print("‚ùå Docker: Nie zainstalowany lub niedostƒôpny")

    # Sprawd≈∫ curl
    try:
        result = subprocess.run(['curl', '--version'],
                                capture_output=True, text=True, timeout=5)
        if result.returncode == 0:
            requirements['curl'] = True
            print("‚úÖ curl: Dostƒôpny")
    except:
        print("‚ùå curl: Nie zainstalowany")

    # Sprawd≈∫ git
    try:
        result = subprocess.run(['git', '--version'],
                                capture_output=True, text=True, timeout=5)
        if result.returncode == 0:
            requirements['git'] = True
            print("‚úÖ git: Dostƒôpny")
    except:
        print("‚ùå git: Nie zainstalowany")

    return requirements


def print_summary_and_recommendations():
    """Wy≈õwietl podsumowanie i rekomendacje"""
    print("\n" + "=" * 60)
    print("üìã PODSUMOWANIE I REKOMENDACJE")
    print("=" * 60)

    recommendations = [
        {
            'title': 'üöÄ Szybki start - Gotowy Docker',
            'description': 'U≈ºyj gotowego kontenera EMLRender',
            'commands': [
                'docker pull rootshell/emlrender:latest',
                'docker run -d -p 8443:443 rootshell/emlrender:latest',
                'curl -k https://localhost:8443/help'
            ],
            'pros': ['Gotowy do u≈ºycia', 'Pe≈Çna funkcjonalno≈õƒá', 'Renderowanie do PNG'],
            'cons': ['Wymaga uwierzytelnienia', 'Mniej kontroli nad kodem']
        },
        {
            'title': 'üîß Pe≈Çna kontrola - W≈Çasny serwer',
            'description': 'Zbuduj w≈Çasny serwer z pe≈ÇnƒÖ kontrolƒÖ',
            'commands': [
                'docker build -t my-eml-server .',
                'docker run -d -p 5000:5000 my-eml-server',
                'curl http://localhost:5000/api/health'
            ],
            'pros': ['Pe≈Çna kontrola', 'Mo≈ºliwo≈õƒá modyfikacji', 'API REST', 'Brak uwierzytelnienia'],
            'cons': ['Wymaga budowania', 'Wiƒôcej konfiguracji']
        },
        {
            'title': 'üêç Biblioteka Python - Integracja',
            'description': 'Integruj bezpo≈õrednio w aplikacji Python',
            'commands': [
                'pip install eml-parser python-magic-bin',
                'python eml_advanced_parser.py',
                'python eml_renderer_basic.py'
            ],
            'pros': ['Najlepsza integracja', 'Pe≈Çna elastyczno≈õƒá', 'Bez Docker'],
            'cons': ['Wymaga zarzƒÖdzania zale≈ºno≈õciami', 'Tylko Python']
        }
    ]

    for rec in recommendations:
        print(f"\n{rec['title']}")
        print("-" * len(rec['title']))
        print(f"üìù {rec['description']}")

        print("\nüíª Komendy:")
        for cmd in rec['commands']:
            print(f"   {cmd}")

        print(f"\n‚úÖ Zalety: {', '.join(rec['pros'])}")
        print(f"‚ùå Wady: {', '.join(rec['cons'])}")

    print(f"\nüéØ REKOMENDACJA:")
    print("1. **Dla szybkiego testowania**: U≈ºyj gotowego Docker EMLRender")
    print("2. **Dla produkcji**: Zbuduj w≈Çasny serwer z pe≈ÇnƒÖ kontrolƒÖ")
    print("3. **Dla integracji**: U≈ºyj bibliotek Python bezpo≈õrednio")


def run_comprehensive_demo():
    """Uruchom kompletnƒÖ demonstracjƒô"""
    print("üß™ KOMPLEKSOWA DEMONSTRACJA ROZWIƒÑZA≈É EML")
    print("=" * 60)
    print("Ten skrypt demonstruje r√≥≈ºne podej≈õcia do renderowania plik√≥w EML")
    print("Sprawdza dostƒôpno≈õƒá i testuje ka≈ºde rozwiƒÖzanie")

    # Sprawd≈∫ wymagania
    requirements = check_system_requirements()

    # Stw√≥rz kompleksowy plik testowy
    print(f"\nüìß Tworzenie kompleksowego pliku testowego...")
    test_eml = create_comprehensive_test_eml()
    with open('comprehensive_test.eml', 'w', encoding='utf-8') as f:
        f.write(test_eml)
    print("‚úÖ Utworzono: comprehensive_test.eml")

    # Test ka≈ºdego podej≈õcia
    results = {}

    # 1. Test wbudowanych bibliotek Python
    results['builtin'] = test_builtin_python_approach()

    # 2. Test zaawansowanej biblioteki
    results['advanced'] = test_advanced_eml_parser()

    # 3. Test Docker EMLRender
    if requirements['Docker']:
        results['docker_emlrender'] = test_docker_emlrender()
    else:
        print("\n‚ö†Ô∏è Pomijam test Docker EMLRender - Docker niedostƒôpny")
        results['docker_emlrender'] = False

    # 4. Test w≈Çasnego serwera
    if requirements['Docker']:
        results['custom_server'] = test_custom_docker_server()
    else:
        print("\n‚ö†Ô∏è Pomijam test w≈Çasnego serwera - Docker niedostƒôpny")
        results['custom_server'] = False

    # Podsumowanie wynik√≥w
    print(f"\nüìä WYNIKI TEST√ìW:")
    print("=" * 60)
    for test_name, success in results.items():
        status = "‚úÖ SUKCES" if success else "‚ùå B≈ÅƒÑD"
        test_display = {
            'builtin': 'Wbudowane biblioteki Python',
            'advanced': 'Zaawansowana biblioteka eml-parser',
            'docker_emlrender': 'Docker EMLRender',
            'custom_server': 'W≈Çasny serwer Docker'
        }
        print(f"{status} {test_display.get(test_name, test_name)}")

    successful_tests = sum(results.values())
    total_tests = len(results)
    print(f"\nüéØ Wynik og√≥lny: {successful_tests}/{total_tests} test√≥w przesz≈Ço pomy≈õlnie")

    # Rekomendacje
    print_summary_and_recommendations()

    # PosprzƒÖtaj
    files_to_cleanup = ['comprehensive_test.eml', 'test_rendered.html']
    for file in files_to_cleanup:
        if os.path.exists(file):
            os.remove(file)
            print(f"üóëÔ∏è Usuniƒôto: {file}")


if __name__ == "__main__":
    try:
        run_comprehensive_demo()

        print(f"\nüéâ DEMONSTRACJA ZAKO≈ÉCZONA")
        print("=" * 60)
        print("üìö Sprawd≈∫ artefakty w tym czacie aby uzyskaƒá pe≈Çny kod:")
        print("   ‚Ä¢ eml_renderer_basic.py - Podstawowy renderer Python")
        print("   ‚Ä¢ eml_advanced_parser.py - Zaawansowany parser z eml-parser")
        print("   ‚Ä¢ docker_eml_setup.sh - Setup Docker EMLRender")
        print("   ‚Ä¢ python_eml_client.py - Klient API Python")
        print("   ‚Ä¢ eml_render_server.py - W≈Çasny serwer Flask")
        print("   ‚Ä¢ Dockerfile + docker-compose.yml - Konfiguracja Docker")

        print(f"\nüí° NASTƒòPNE KROKI:")
        print("1. Wybierz rozwiƒÖzanie odpowiednie dla Twoich potrzeb")
        print("2. Zainstaluj wymagane zale≈ºno≈õci")
        print("3. Przetestuj z w≈Çasnymi plikami EML")
        print("4. Dostosuj kod do swoich wymaga≈Ñ")

    except KeyboardInterrupt:
        print(f"\n\n‚èπÔ∏è Demonstracja przerwana przez u≈ºytkownika")
    except Exception as e:
        print(f"\n\n‚ùå B≈ÇƒÖd podczas demonstracji: {e}")
        print("üîç Sprawd≈∫ logi powy≈ºej dla szczeg√≥≈Ç√≥w")